## Setup roles and users for Beat setup and Beat writer

For 7.0 - 7.4:
https://github.com/elastic/csm/blob/master/FiveBestPracticesForIngest/RoleBasedAccessControl.md

For 7.5 things change slightly, I am working on it.

## Three Beats will be deployed:

- Filebeat
- Metricbeat
- Heartbeat

### Filebeat

Install by following the instructions in Kibana Home and then enable the relevant modules:

```
sudo filebeat modules enable apache auditd mysql system
```

Setup the Filebeat keystore

See the instructions in https://github.com/elastic/csm/blob/master/FiveBestPracticesForIngest/cheatsheet.md#filebeat-keystore

Edit filebeat.yml and specify the cloud.id and cloud.auth and set other relevant settings

#### filebeat.yml
```
#==================== ILM is setup by CLI ============================

setup.ilm.check_exists: false

#====================== Modules config ===============================

filebeat.config.modules:
  # Glob pattern for configuration loading
  path: ${path.config}/modules.d/*.yml

  # Set to true to enable config reloading
  reload.enabled: false

  # Period on which files under path should be checked for changes
  #reload.period: 10s

#================ Elasticsearch template setting ======================

setup.template.settings:
  index.number_of_shards: 1
  #index.codec: best_compression
  #_source.enabled: false

#============== Elasticsearch Service on Elastic Cloud =================

cloud.id: "Observability:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDY4NDI4YWUxMzUzMTRlNjJiMGRhNTZiOWEzYjRhMTBmJDU3YzU5NzM5Y2NmYjQ2ZTRiNWNjMjY2MjIyNzcwYjZj"

cloud.auth: "${ES_USER}:${ES_USER_PASSWORD}"

#============================ Processors =================================

# Configure processors to enhance or manipulate events generated by the beat.

processors:
  - add_host_metadata:
      netinfo.enabled: true
  - add_cloud_metadata: ~
  - add_fields:
      target: ''
      fields:
        service.name: 'Online Banking'
        service.id: 'ob-canada'

#============================ Logging =====================================

logging.level: error

#========================== Stack Monitoring ==============================

monitoring.enabled: true

#============================= Spooling  ==================================

queue.spool: ~
```

## Metricbeat

### metricbeat.yml

```
setup.ilm.check_exists: false

metricbeat.config.modules:
  # Glob pattern for configuration loading
  path: ${path.config}/modules.d/*.yml

  # Set to true to enable config reloading
  reload.enabled: false

  # Period on which files under path should be checked for changes
  #reload.period: 10s

setup.template.settings:
  index.number_of_shards: 1
  index.codec: best_compression
  #_source.enabled: false


cloud.id: "Observability:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDY4NDI4YWUxMzUzMTRlNjJiMGRhNTZiOWEzYjRhMTBmJDU3YzU5NzM5Y2NmYjQ2ZTRiNWNjMjY2MjIyNzcwYjZj"

cloud.auth: "${ES_USER}:${ES_USER_PASSWORD}"


processors:
  #- add_host_metadata: ~
  - add_host_metadata:
      netinfo.enabled: true
      cache.ttl: 5m
  - add_cloud_metadata: ~
  - add_fields:
      target: ''
      fields:
        service.name: 'Online Banking'
        service.id: 'ob-canada'

logging.level: error

monitoring.enabled: true

queue.spool: ~
```

### /etc/metricbeat/modules.d/mysql.yml 

When deploying the sample Spring app mysql is deployed and configured.  In the setup instructions the mysql user and password are specified.  The username is `springuser` and the password is `ThePassword`. The hosts array in the following config file is `hosts: ["springuser:ThePassword@tcp(127.0.0.1:3306)/"]`

Note: The username and password should not be in the file, the keystore should be used.

```
- module: mysql
  #metricsets:
  #  - status
  #  - galera_status
  period: 10s

  # Host DSN should be defined as "user:pass@tcp(127.0.0.1:3306)/"
  # The username and password can either be set in the DSN or using the username
  # and password config options. Those specified in the DSN take precedence.
  #hosts: ["root:secret@tcp(127.0.0.1:3306)/"]
  hosts: ["springuser:ThePassword@tcp(127.0.0.1:3306)/"]
```

## Heartbeat

### heartbeat.yml
```
heartbeat.config.monitors:
  # Directory + glob pattern to search for configuration files
  path: ${path.config}/monitors.d/*.yml
  # If enabled, heartbeat will periodically check the config.monitors path for changes
  reload.enabled: false
  # How often to check for changes
  reload.period: 5s

setup.template.settings:
  index.number_of_shards: 1
  index.codec: best_compression
  #_source.enabled: false

cloud.id: "Observability:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDY4NDI4YWUxMzUzMTRlNjJiMGRhNTZiOWEzYjRhMTBmJDU3YzU5NzM5Y2NmYjQ2ZTRiNWNjMjY2MjIyNzcwYjZj"

cloud.auth: "${ES_USER}:${ES_USER_PASSWORD}"

processors:
  - add_observer_metadata:

logging.level: error

monitoring.enabled: true
```

#### /etc/heartbeat/monitors.d/spring.http.yml

The following configuration specifies that every 5 seconds the `add` endpoint will be accessed
and the response will be compared to the strings `Saved` and `saved`

```
- type: http
  #
  # Replaces:
  # curl localhost:8080/demo/add -d name=First \
  # -d email=someemail@someemailprovider.com
  #
  # Adds: Checking response body for 'Saved'
  #

  name: SpringToDoApp
  schedule: '@every 5s'
  urls: ["http://10.0.2.15:8080/demo/add"]
  check.request:
    method: POST
    headers: 
      'Content-Type': 'application/x-www-form-urlencoded'
    body: "name=dan&email=dan%40example.com"
  check.response:
    status: 200
    body:
      - Saved
      - saved
  response.include_body: 'always'
  ```
